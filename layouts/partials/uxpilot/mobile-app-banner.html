{{ $banner := .Site.Params.appBanner }}
{{ if $banner }}
  {{ $bannerJSON := $banner | jsonify }}
  <div
    id="mobile-app-download-banner"
    class="w-full p-2 flex md:hidden flex-wrap sm:flex-nowrap justify-center sm:justify-between items-center gap-4 dark:bg-indigo-300 bg-indigo-100 align-middle text-sm sm:text-base border-b border-gray-200 dark:border-gray-800/60"
    data-mobile-banner
  >
    <div class="flex items-center gap-3">
      <img src="/images/ico-hologram.png" alt="Hologram" width="32" height="32" class="w-8 h-8 flex-shrink-0" loading="lazy" decoding="async" />
      <p>
        <span class="font-semibold block">Hologram Messaging</span>
        <span class="text-gray-700 dark:text-gray-900 text-xs sm:text-sm">{{ or $banner.subtitle "Chat & Verificable Credentials" }}</span>
      </p>
    </div>
    <div class="flex gap-2" data-banner-buttons>
      <a data-store-link="ios" class="hidden bg-hologram-primary hover:bg-hologram-secondary text-white font-semibold h-8 w-20 px-4 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-white/70 flex items-center justify-center">
        Get
      </a>
      <a data-store-link="google" class="hidden bg-hologram-primary hover:bg-hologram-secondary text-white font-semibold h-8 w-20 px-4 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-white/70 flex items-center justify-center">
        Install
      </a>
      <a data-store-link="huawei" class="hidden bg-hologram-primary hover:bg-hologram-secondary text-white font-semibold h-8 w-20 px-4 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-white/70 flex items-center justify-center">
        Install
      </a>
    </div>
  </div>
  <script>
    (function(){
      const config = {{ $bannerJSON | safeJS }};

      function init(){
        const banner = document.getElementById('mobile-app-download-banner');
        if (!banner || !config) return;

        const search = window.location.search || '';
        const params = new URLSearchParams(search);
        const hasOob = params.has('oob') || params.has('_oob');

        const ua = (navigator.userAgent || '').toLowerCase();
        const isIOS = /iphone|ipod/.test(ua);
        const isAndroid = /android/.test(ua);
        const isTablet = /ipad|tablet/.test(ua);
        const isMobile = (isIOS || isAndroid) && !isTablet;
        const isHuawei = /huawei|honor/.test(ua) || typeof window.hms !== 'undefined';

        if (!isMobile || hasOob) return;

        const referrer = search || '';
        const buttons = banner.querySelector('[data-banner-buttons]');
        if (!buttons) return;

        const iosBtn = buttons.querySelector('[data-store-link="ios"]');
        const googleBtn = buttons.querySelector('[data-store-link="google"]');
        const huaweiBtn = buttons.querySelector('[data-store-link="huawei"]');

        const linkMap = {
          ios: config.iosUrl || '',
          google: config.googleUrl || '',
          huawei: config.huaweiUrl || '',
        };

        function configureLink(el, store){
          const base = linkMap[store];
          if (!el || !base) return false;
          const separator = base.includes('?') ? '&' : '?';
          const target = referrer ? `${base}${separator}referrer=${encodeURIComponent(referrer)}` : base;
          el.href = target;
          el.target = '_blank';
          el.rel = 'noopener noreferrer';
          el.classList.remove('hidden');
          return true;
        }

        const iosVisible = isIOS && configureLink(iosBtn, 'ios');
        const googleVisible =
          !isIOS &&
          (!isHuawei || typeof window.google !== 'undefined') &&
          configureLink(googleBtn, 'google');
        const huaweiVisible = isHuawei && configureLink(huaweiBtn, 'huawei');

        if (iosVisible || googleVisible || huaweiVisible) {
          banner.classList.remove('hidden');
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })();
  </script>
{{ end }}
