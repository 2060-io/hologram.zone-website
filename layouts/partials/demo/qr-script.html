<script>
(function(){
  if (window.hologramDemoQrInit) return;
  window.hologramDemoQrInit = true;
  let activeId = null;

  const escapeAttr = typeof CSS !== 'undefined' && CSS.escape ? CSS.escape : function(value){
    return value.replace(/["\\]/g, '\\$&');
  };

  function getMedia(id){
    if (!id) return null;
    const selector = '[data-demo-media="' + escapeAttr(id) + '"]';
    return document.querySelector(selector) || document.querySelector('[data-demo-media="' + id + '"]');
  }

  function setState(media, state){
    if (!media) return;
    const imageBlock = media.querySelector('[data-demo-media-image]');
    const qrBlock = media.querySelector('[data-demo-media-qr]');
    if (!imageBlock || !qrBlock) return;
    if (state === 'qr'){
      imageBlock.classList.add('hidden');
      qrBlock.classList.remove('hidden');
      media.dataset.demoMediaState = 'qr';
    } else {
      imageBlock.classList.remove('hidden');
      qrBlock.classList.add('hidden');
      media.dataset.demoMediaState = 'image';
    }
  }

  function clearMedia(media){
    if (!media) return;
    setState(media, 'image');
    const img = media.querySelector('[data-demo-qr-img]');
    if (img) img.removeAttribute('src');
  }

  function hideActive(){
    if (!activeId) return;
    const media = getMedia(activeId);
    clearMedia(media);
    activeId = null;
  }

  function showQr(targetId, url){
    const media = getMedia(targetId);
    if (!media) return;
    const qrImg = media.querySelector('[data-demo-qr-img]');
    if (!qrImg) return;
    if (activeId && activeId !== targetId){
      hideActive();
    }
    qrImg.src = url;
    setState(media, 'qr');
    activeId = targetId;
  }

  document.addEventListener('click', function(event){
    const btn = event.target.closest('[data-demo-qr-btn]');
    if (btn){
      const url = btn.getAttribute('data-demo-qr-url');
      const href = btn.getAttribute('href');
      const targetId = btn.getAttribute('data-demo-qr-target');
      if (!url || !targetId) return;
      if (href){
        const newWindow = window.open(href, '_blank', 'noopener,noreferrer');
        if (newWindow) newWindow.opener = null;
      }
      event.preventDefault();
      if (activeId === targetId){
        hideActive();
        return;
      }
      showQr(targetId, url);
      return;
    }
    const closeBtn = event.target.closest('[data-demo-qr-close]');
    if (closeBtn){
      const media = closeBtn.closest('[data-demo-media]');
      if (media){
        const mediaId = media.getAttribute('data-demo-media');
        clearMedia(media);
        if (mediaId && mediaId === activeId){
          activeId = null;
        }
      } else {
        hideActive();
      }
      const href = (closeBtn.getAttribute('href') || '').trim();
      const isLink = closeBtn.tagName && closeBtn.tagName.toLowerCase() === 'a';
      const lowerHref = href.toLowerCase();
      if (!isLink || !href || href === '#' || lowerHref === 'javascript:void(0)' || lowerHref === 'javascript:void(0);' || lowerHref.startsWith('javascript:')){
        event.preventDefault();
      }
    }
  });
})();
</script>
